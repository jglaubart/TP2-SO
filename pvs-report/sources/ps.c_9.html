<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ps.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is an open source non-commercial project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++ and C#: http://www.viva64.com</a>
<a name="ln3">#include &quot;commands.h&quot;</a>
<a name="ln4"> </a>
<a name="ln5">int _ps(int argc, char * argv[]){ // TODO: MODOFICAR, ver de hacer mas corto o mover de archivo</a>
<a name="ln6">    if (argc &gt; 1) {</a>
<a name="ln7">		perror(&quot;Usage: ps\n&quot;);</a>
<a name="ln8">		return 1;</a>
<a name="ln9">	}</a>
<a name="ln10"> </a>
<a name="ln11">    static ProcessInformation processInfo[64];</a>
<a name="ln12">    int count = ps(processInfo);</a>
<a name="ln13">    if (count &lt; 0){</a>
<a name="ln14">        perror(&quot;ps: syscall failed\n&quot;);</a>
<a name="ln15">        return count;</a>
<a name="ln16">    }</a>
<a name="ln17">    if (count == 0){</a>
<a name="ln18">        printf(&quot;No processes found\n&quot;);</a>
<a name="ln19">        return 0;</a>
<a name="ln20">    }</a>
<a name="ln21"> </a>
<a name="ln22">    const char * colors[] = {</a>
<a name="ln23">        [PROCESS_STATE_READY]      = &quot;\e[0;33m&quot;,</a>
<a name="ln24">        [PROCESS_STATE_RUNNING]    = &quot;\e[0;32m&quot;,</a>
<a name="ln25">        [PROCESS_STATE_BLOCKED]    = &quot;\e[0;31m&quot;,</a>
<a name="ln26">        [PROCESS_STATE_TERMINATED] = &quot;\e[0;90m&quot;</a>
<a name="ln27">    };</a>
<a name="ln28">    const char * stateNames[] = {</a>
<a name="ln29">        [PROCESS_STATE_READY]      = &quot;READY&quot;,</a>
<a name="ln30">        [PROCESS_STATE_RUNNING]    = &quot;RUNNING&quot;,</a>
<a name="ln31">        [PROCESS_STATE_BLOCKED]    = &quot;BLOCKED&quot;,</a>
<a name="ln32">        [PROCESS_STATE_TERMINATED] = &quot;TERMINATED&quot;</a>
<a name="ln33">    };</a>
<a name="ln34">    const char * reset = &quot;\e[0m&quot;;</a>
<a name="ln35"> </a>
<a name="ln36">    int max_name_length = 4;</a>
<a name="ln37">	for (int i = 0; i &lt; count; i++) {</a>
<a name="ln38">        int len = processInfo[i].name[0] ? (int)strlen(processInfo[i].name) : 0;</a>
<a name="ln39">		if (len &gt; max_name_length) {</a>
<a name="ln40">			max_name_length = len;</a>
<a name="ln41">		}</a>
<a name="ln42">	}</a>
<a name="ln43"> </a>
<a name="ln44">    int header_name_padding = max_name_length - 4;</a>
<a name="ln45">    if (header_name_padding &lt; 2) {</a>
<a name="ln46">        header_name_padding = 2;</a>
<a name="ln47">    }</a>
<a name="ln48">    char padding_header[header_name_padding + 1];</a>
<a name="ln49">    int j = 0;</a>
<a name="ln50">    for (; j &lt; header_name_padding; j++) {</a>
<a name="ln51">        padding_header[j] = ' ';</a>
<a name="ln52">    }</a>
<a name="ln53">    padding_header[j] = '\0';</a>
<a name="ln54"> </a>
<a name="ln55">    const int state_header_target = 10;</a>
<a name="ln56">    int header_state_padding = state_header_target - 5; /* &quot;State&quot; */</a>
<a name="ln57">    if (header_state_padding &lt; 2) {</a>
<a name="ln58">        header_state_padding = 2;</a>
<a name="ln59">    }</a>
<a name="ln60">    char padding_state_header[header_state_padding + 1];</a>
<a name="ln61">    j = 0;</a>
<a name="ln62">    for (; j &lt; header_state_padding; j++) {</a>
<a name="ln63">        padding_state_header[j] = ' ';</a>
<a name="ln64">    }</a>
<a name="ln65">    padding_state_header[j] = '\0';</a>
<a name="ln66"> </a>
<a name="ln67">	printf(&quot;\e[0;0mPID\tName%sState%sPriority\tRSP\t\tRBP\t\tIn foreground\n&quot;,</a>
<a name="ln68">	       padding_header, padding_state_header);</a>
<a name="ln69"> </a>
<a name="ln70">    for (int i = 0; i &lt; count; i++) {</a>
<a name="ln71">        const char *name = processInfo[i].name[0] ? processInfo[i].name : &quot;&lt;unnamed&gt;&quot;;</a>
<a name="ln72">        int name_len = (int)strlen(name);</a>
<a name="ln73">        int padding_len = max_name_length - name_len + 2;</a>
<a name="ln74">        if (padding_len &lt; 2) {</a>
<a name="ln75">            padding_len = 2;</a>
<a name="ln76">        }</a>
<a name="ln77">        char padding[padding_len + 1];</a>
<a name="ln78">        int k = 0;</a>
<a name="ln79">        for (; k &lt; padding_len; k++) {</a>
<a name="ln80">            padding[k] = ' ';</a>
<a name="ln81">        }</a>
<a name="ln82">        padding[k] = '\0';</a>
<a name="ln83"> </a>
<a name="ln84">        ProcessState state = processInfo[i].state;</a>
<a name="ln85">        const char *state_color = (state &gt;= PROCESS_STATE_READY &amp;&amp; state &lt;= PROCESS_STATE_TERMINATED &amp;&amp; colors[state])</a>
<a name="ln86">                                      ? colors[state]</a>
<a name="ln87">                                      : reset;</a>
<a name="ln88">        const char *state_name = (state &gt;= PROCESS_STATE_READY &amp;&amp; state &lt;= PROCESS_STATE_TERMINATED &amp;&amp; stateNames[state])</a>
<a name="ln89">                                     ? stateNames[state]</a>
<a name="ln90">                                     : &quot;UNKNOWN&quot;;</a>
<a name="ln91">        int state_len = (int)strlen(state_name);</a>
<a name="ln92">        int state_padding_len = state_header_target - state_len;</a>
<a name="ln93">        if (state_padding_len &lt; 1) {</a>
<a name="ln94">            state_padding_len = 1;</a>
<a name="ln95">        }</a>
<a name="ln96">        char state_padding[state_padding_len + 1];</a>
<a name="ln97">        k = 0;</a>
<a name="ln98">        for (; k &lt; state_padding_len; k++) {</a>
<a name="ln99">            state_padding[k] = ' ';</a>
<a name="ln100">        }</a>
<a name="ln101">        state_padding[k] = '\0';</a>
<a name="ln102"> </a>
<a name="ln103">        unsigned int rsp = (unsigned int)(uintptr_t)processInfo[i].rsp;</a>
<a name="ln104">        unsigned int stack_base = (unsigned int)(uintptr_t)processInfo[i].stack_base;</a>
<a name="ln105"> </a>
<a name="ln106">        printf(&quot;%d\t%s%s%s%s%s%s%d\t\t0x%x\t0x%x\t%s\n&quot;,</a>
<a name="ln107">			   processInfo[i].pid, name, padding, state_color, state_name, reset, state_padding,</a>
<a name="ln108">			   processInfo[i].priority, rsp, stack_base, processInfo[i].is_foreground ? &quot;Yes&quot; : &quot;No&quot;);</a>
<a name="ln109">	}</a>
<a name="ln110">	return 0;</a>
<a name="ln111">}</a>
</code></pre>
<div class="balloon" rel="57"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v547/" target="_blank">V547</a> Expression 'header_state_padding &lt; 2' is always false.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>