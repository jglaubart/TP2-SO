<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>stdio.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is an open source non-commercial project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++ and C#: http://www.viva64.com</a>
<a name="ln3"> </a>
<a name="ln4">#include &lt;stdio.h&gt;</a>
<a name="ln5">#include &lt;string.h&gt;</a>
<a name="ln6">#include &lt;syscalls.h&gt;</a>
<a name="ln7"> </a>
<a name="ln8">#ifdef ANSI_4_BIT_COLOR_SUPPORT</a>
<a name="ln9">    #include &lt;ansiColors.h&gt;</a>
<a name="ln10">#endif</a>
<a name="ln11"> </a>
<a name="ln12">static char buffer[64] = {0};</a>
<a name="ln13"> </a>
<a name="ln14">static uint32_t uintToBase(uint64_t value, char * buffer, uint32_t base);</a>
<a name="ln15">static void printBase(int fd, int num, int base);</a>
<a name="ln16">// static void printFloat(int fd, float num);</a>
<a name="ln17"> </a>
<a name="ln18">void puts(const char * str) {</a>
<a name="ln19">    printf(str);</a>
<a name="ln20">    printf(&quot;\n&quot;);</a>
<a name="ln21">}</a>
<a name="ln22"> </a>
<a name="ln23">void vfprintf(int fd, const char * format, va_list args) {</a>
<a name="ln24">    int i = 0;</a>
<a name="ln25">    while (format[i] != 0) {</a>
<a name="ln26">        switch (format[i]) {</a>
<a name="ln27">        case '\e':</a>
<a name="ln28">        #ifdef ANSI_4_BIT_COLOR_SUPPORT</a>
<a name="ln29">            sys_write(fd, &amp;format[i], 0); // &quot;writes&quot; (ignored because of count=0) \e char to account for fd changes</a>
<a name="ln30">            parseANSI(format, &amp;i);</a>
<a name="ln31">            break ;</a>
<a name="ln32">        #else</a>
<a name="ln33">            while(format[i] != 'm') i++; // ignore ANSI escape codes, assumes valid \e[X,Ym format</a>
<a name="ln34">            i++;</a>
<a name="ln35">            break ;</a>
<a name="ln36">        #endif</a>
<a name="ln37">        case '%':</a>
<a name="ln38">            i++;</a>
<a name="ln39">            switch (format[i]) {</a>
<a name="ln40">                case 'x': printBase(fd, va_arg(args, int), 16); break ;</a>
<a name="ln41">                case 'd': printBase(fd, va_arg(args, int), 10); break ;</a>
<a name="ln42">                case 'o': printBase(fd, va_arg(args, int), 8); break ;</a>
<a name="ln43">                case 'b': printBase(fd, va_arg(args, int), 2); break ;</a>
<a name="ln44">                // case 'f': printFloat(fd, va_arg(args, double)); break ;</a>
<a name="ln45">                case 'c': {</a>
<a name="ln46">                    char c = (char) va_arg(args, int);</a>
<a name="ln47">                    sys_write(fd, &amp;c, 1);</a>
<a name="ln48">                    break ;</a>
<a name="ln49">                }</a>
<a name="ln50">                case 's': fprintf(fd, va_arg(args, char *)); break ;</a>
<a name="ln51">                case '%': sys_write(fd, &quot;%&quot;, 1); break ;</a>
<a name="ln52">            }</a>
<a name="ln53">            i++;</a>
<a name="ln54">            break ;</a>
<a name="ln55">        default:</a>
<a name="ln56">            sys_write(fd, &amp;format[i], 1);</a>
<a name="ln57">            i++;</a>
<a name="ln58">            break ;</a>
<a name="ln59">        }</a>
<a name="ln60">    }</a>
<a name="ln61">}</a>
<a name="ln62"> </a>
<a name="ln63">void printf(const char * format, ...) {</a>
<a name="ln64">    va_list args;</a>
<a name="ln65">    va_start(args, format);</a>
<a name="ln66">    vfprintf(FD_STDOUT, format, args);</a>
<a name="ln67">    va_end(args);</a>
<a name="ln68">}</a>
<a name="ln69"> </a>
<a name="ln70">void fprintf(int fd, const char * str, ...) {</a>
<a name="ln71">    va_list args;</a>
<a name="ln72">    va_start(args, str);</a>
<a name="ln73">    vfprintf(fd, str, args);</a>
<a name="ln74">    va_end(args);</a>
<a name="ln75">}</a>
<a name="ln76"> </a>
<a name="ln77">int vscanf(const char * format, va_list args) {</a>
<a name="ln78">    int i = 0;</a>
<a name="ln79">    int args_read = 0;</a>
<a name="ln80">    char c;</a>
<a name="ln81">    while (format[i] != 0) {</a>
<a name="ln82">        switch (format[i]) {</a>
<a name="ln83">            case '%':</a>
<a name="ln84">                i++;</a>
<a name="ln85">                switch (format[i]) {</a>
<a name="ln86">                    case 'd':</a>
<a name="ln87">                        int64_t num = 0;</a>
<a name="ln88">                        uint8_t negative = 0;</a>
<a name="ln89"> </a>
<a name="ln90">                        c = getchar();</a>
<a name="ln91"> </a>
<a name="ln92">                        if (c != '-' &amp;&amp; (c &lt; '0' || c &gt; '9')) {</a>
<a name="ln93">                            while ((c = getchar()) != '\n'); // empty input buffer</a>
<a name="ln94">                            break ;</a>
<a name="ln95">                        };</a>
<a name="ln96"> </a>
<a name="ln97">                        do {</a>
<a name="ln98">                            if (c == '-') {</a>
<a name="ln99">                                negative = 1;</a>
<a name="ln100">                            } else {</a>
<a name="ln101">                                num = num * 10 + c - '0';</a>
<a name="ln102">                            }</a>
<a name="ln103">                        } while (((c = getchar()) &gt;= '0' &amp;&amp; c &lt;= '9') || (num == 0 &amp;&amp; c == '-'));</a>
<a name="ln104"> </a>
<a name="ln105">                        *va_arg(args, int *) = num * (negative ? -1 : 1);</a>
<a name="ln106">                        args_read++;</a>
<a name="ln107">                        break;</a>
<a name="ln108">                    case 'c':</a>
<a name="ln109">                        *va_arg(args, char *) = getchar();</a>
<a name="ln110">                        args_read++;</a>
<a name="ln111">                        break;</a>
<a name="ln112">                    case 's':</a>
<a name="ln113">                        char * str = va_arg(args, char *);</a>
<a name="ln114">                        while ((c = getchar()) != ' ' &amp;&amp; c != '\n') {</a>
<a name="ln115">                            *str = c;</a>
<a name="ln116">                            str++;</a>
<a name="ln117">                        }</a>
<a name="ln118">                        *str = 0;</a>
<a name="ln119">                        args_read++;</a>
<a name="ln120">                        break;</a>
<a name="ln121">                }</a>
<a name="ln122">        }</a>
<a name="ln123">        i++;</a>
<a name="ln124">    }</a>
<a name="ln125">    return args_read;               </a>
<a name="ln126">}</a>
<a name="ln127"> </a>
<a name="ln128">int vsscanf(const char * buffer, const char * format, va_list args) {</a>
<a name="ln129">    int form_i = 0;</a>
<a name="ln130">    int buf_i = 0;</a>
<a name="ln131">    int args_read = 0;</a>
<a name="ln132">    while (format[form_i] != 0) {</a>
<a name="ln133">        switch (format[form_i]) {</a>
<a name="ln134">            case '%':</a>
<a name="ln135">                form_i++;</a>
<a name="ln136">                switch (format[form_i]) {</a>
<a name="ln137">                    case 'd' : {</a>
<a name="ln138">                        int num = 0;</a>
<a name="ln139">                        uint8_t read_num = 0, negative = 0;</a>
<a name="ln140"> </a>
<a name="ln141">                        if (buffer[buf_i] != '-' &amp;&amp; (buffer[buf_i] &lt; '0' || buffer[buf_i] &gt; '9')) break;</a>
<a name="ln142"> </a>
<a name="ln143">                        if (buffer[buf_i] == '-') { negative = 1; buf_i++; };</a>
<a name="ln144">                        </a>
<a name="ln145">                        while (buffer[buf_i] &gt;= '0' &amp;&amp; buffer[buf_i] &lt;= '9') {</a>
<a name="ln146">                            num = num * 10 + buffer[buf_i] - '0';</a>
<a name="ln147">                            buf_i++;</a>
<a name="ln148">                            read_num = 1;</a>
<a name="ln149">                        }</a>
<a name="ln150"> </a>
<a name="ln151">                        *va_arg(args, int *) = num * (negative ? -1 : 1);</a>
<a name="ln152">                        args_read += read_num;</a>
<a name="ln153">                        break;</a>
<a name="ln154">                    }</a>
<a name="ln155">                    case 'c': {</a>
<a name="ln156">                        *va_arg(args, char *) = buffer[buf_i++];</a>
<a name="ln157">                        args_read++;</a>
<a name="ln158">                        break;</a>
<a name="ln159">                    }</a>
<a name="ln160">                    case 's': {</a>
<a name="ln161">                        char * str = va_arg(args, char *);</a>
<a name="ln162">                        while (buffer[buf_i] != ' ' &amp;&amp; buffer[buf_i] != '\n' &amp;&amp; buffer[buf_i] != 0) {</a>
<a name="ln163">                            *(str++) = buffer[buf_i];</a>
<a name="ln164">                            str++;</a>
<a name="ln165">                            buf_i++;</a>
<a name="ln166">                        }</a>
<a name="ln167">                        *str = 0;</a>
<a name="ln168">                        args_read++;</a>
<a name="ln169">                        break;</a>
<a name="ln170">                    }</a>
<a name="ln171">                    default:</a>
<a name="ln172">                        break;</a>
<a name="ln173">                }</a>
<a name="ln174">        }</a>
<a name="ln175">        form_i++;</a>
<a name="ln176">    }</a>
<a name="ln177">    return args_read;</a>
<a name="ln178">}</a>
<a name="ln179"> </a>
<a name="ln180">int sscanf(const char * str, const char * format, ...) {</a>
<a name="ln181">    va_list args;</a>
<a name="ln182">    va_start(args, format);</a>
<a name="ln183">    int aux = vsscanf(str, format, args);</a>
<a name="ln184">    va_end(args);</a>
<a name="ln185">    return aux;</a>
<a name="ln186">}</a>
<a name="ln187"> </a>
<a name="ln188">int scanf(const char * format, ...) {</a>
<a name="ln189">    va_list args;</a>
<a name="ln190">    va_start(args, format);</a>
<a name="ln191">    int aux = vscanf(format, args);</a>
<a name="ln192">    va_end(args);</a>
<a name="ln193">    return aux;</a>
<a name="ln194">}</a>
<a name="ln195"> </a>
<a name="ln196">void perror(const char * s1) {</a>
<a name="ln197">    fprintf(FD_STDERR, s1);</a>
<a name="ln198">}</a>
<a name="ln199"> </a>
<a name="ln200">int getchar(void) {</a>
<a name="ln201">    signed char c[1];</a>
<a name="ln202">    int32_t read_bytes;</a>
<a name="ln203"> </a>
<a name="ln204">    while ((read_bytes = sys_read(FD_STDIN, c, 1)) == -1);</a>
<a name="ln205"> </a>
<a name="ln206">    if (read_bytes == 0) {</a>
<a name="ln207">        return -1;</a>
<a name="ln208">    }</a>
<a name="ln209"> </a>
<a name="ln210">    return c[0];</a>
<a name="ln211">}</a>
<a name="ln212"> </a>
<a name="ln213">void putchar(const char c) {</a>
<a name="ln214">    sys_write(FD_STDOUT, &amp;c, 1);</a>
<a name="ln215">};</a>
<a name="ln216"> </a>
<a name="ln217">static uint32_t uintToBase(uint64_t value, char * buffer, uint32_t base)</a>
<a name="ln218">{</a>
<a name="ln219">	char *p = buffer;</a>
<a name="ln220">	char *p1, *p2;</a>
<a name="ln221">	uint32_t digits = 0;</a>
<a name="ln222"> </a>
<a name="ln223">	//Calculate characters for each digit</a>
<a name="ln224">	do</a>
<a name="ln225">	{</a>
<a name="ln226">		uint32_t remainder = value % base;</a>
<a name="ln227">		*p++ = (remainder &lt; 10) ? remainder + '0' : remainder + 'A' - 10;</a>
<a name="ln228">		digits++;</a>
<a name="ln229">	}</a>
<a name="ln230">	while (value /= base);</a>
<a name="ln231"> </a>
<a name="ln232">	// Terminate string in buffer.</a>
<a name="ln233">	*p = 0;</a>
<a name="ln234"> </a>
<a name="ln235">	//Reverse string in buffer.</a>
<a name="ln236">	p1 = buffer;</a>
<a name="ln237">	p2 = p - 1;</a>
<a name="ln238">	while (p1 &lt; p2)</a>
<a name="ln239">	{</a>
<a name="ln240">		char tmp = *p1;</a>
<a name="ln241">		*p1 = *p2;</a>
<a name="ln242">		*p2 = tmp;</a>
<a name="ln243">		p1++;</a>
<a name="ln244">		p2--;</a>
<a name="ln245">	}</a>
<a name="ln246"> </a>
<a name="ln247">	return digits;</a>
<a name="ln248">}</a>
<a name="ln249"> </a>
<a name="ln250">static void printBase(int fd, int num, int base) {</a>
<a name="ln251">    if (num &lt; 0) {fprintf(fd, &quot;-&quot;);}</a>
<a name="ln252">    uintToBase(num, buffer, base);</a>
<a name="ln253">    fprintf(fd, buffer);</a>
<a name="ln254">}</a>
</code></pre>
<div class="balloon" rel="19"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v618/" target="_blank">V618</a> It's dangerous to call the 'printf' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf(&quot;%s&quot;, str);</p></div>
<div class="balloon" rel="50"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v618/" target="_blank">V618</a> It's dangerous to call the 'fprintf' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf(&quot;%s&quot;, str);</p></div>
<div class="balloon" rel="197"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v618/" target="_blank">V618</a> It's dangerous to call the 'fprintf' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf(&quot;%s&quot;, str);</p></div>
<div class="balloon" rel="253"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v618/" target="_blank">V618</a> It's dangerous to call the 'fprintf' function in such a manner, as the line being passed could contain format specification. The example of the safe code: printf(&quot;%s&quot;, str);</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>